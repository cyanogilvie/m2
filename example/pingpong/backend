#!/usr/bin/env cfkit8.6

# vim: ft=tcl foldmethod=marker foldmarker=<<<,>>> ts=4 shiftwidth=4

package require m2
package require cflib

cflib::config create cfg $argv {
	variable uri		"tcp://localhost:5300"
}

m2::api2 create m2 -uri [cfg get uri]

set seq	0
proc ping {seq data} {
	m2 ack $seq "pong: ($data)"
}

[m2 signal_ref connected] attach_output [list apply {
	{newstate} {
		puts "m2 connection state: [expr {$newstate ? "connected" : "not connected"}]"
		if {$newstate} {
			m2 handle_svc "ping" ping
		} else {
			m2 handle_svc "ping" ""
		}
	}
}]

coroutine main apply {
	{} {
		set ::forever 0
		while {1} {
			after 100000 {set ::forever 0}
			vwait ::forever
		}
	}
}


